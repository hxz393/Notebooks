# 网络模块

## 默认网络

Docker通过Network Namespace为每个容器建立了独立网络,形成完全与宿主机隔离的环境.

默认情况下,Docker会在宿主机上架设一个名为docker0的虚拟网络,用来连接宿主机与容器.容器与docker0之间通过Veth Pair来连接,所有连接到docker0上的容器同属于一个子网中,而宿主机也通过虚拟网卡连接到了docker0上.



## 查看网络

可以通过docker network ls命令查看Docker自带的三种网络:

```sh
[root@server4 ~]# docker network ls
NETWORK ID     NAME      DRIVER    SCOPE
3b3d933326d5   bridge    bridge    local
9c9f9149deef   host      host      local
76306c358978   none      null      local
```





## 端口映射

容器与宿主机通过docker0网桥沟通,而容器与外网访问可以通过docker0转发到宿主机外网网卡上,但是外部网络无法访问容器.为解决这一问题,可以使用端口映射方式,将容器的端口与宿主机端口绑定,外部网络便能通过此端口访问容器中的应用和服务.

端口映射可以在建立镜像时使用-P参数,将容器需要暴露端口随机映射到主机空闲端口上(默认49000~49900端口):

```sh
[root@server4 ~]# docker run -d -P nginx
555e6a418454ecbb450e519e09ec483645d97d56569627b827e1b54781f6afde
[root@server4 ~]# docker inspect -f={{.NetworkSettings.Ports}} 555e6a41
map[80/tcp:[{0.0.0.0 49153} {:: 49153}]]
```

使用-p参数来固定要映射到的宿主机端口.可以指定端口类型为udp:

```sh
[root@server4 ~]# docker run -d -p 192.168.2.241:8001:80/udp nginx
38769e47eebdc96ce3f0eded75e6b8c3de90609e42f01a09148911dc4ea025bb
[root@server4 ~]# docker inspect -f={{.NetworkSettings.Ports}} 38769e47
map[80/tcp:[] 80/udp:[{192.168.2.241 8001}]]
```



## 容器连接

有时一个容器中运行的应用程序,需要与运行在另外一个容器中的应用程序通过网络交换数据,这时就需要通过容器连接来完成.

要设置容器间通信,可以在创建容器时使用--link参数指定要连接的容器,这样会打开对被连接容器的网络访问.

例如创建一个MySQL容器,并让一个Web服务容器连接到它:

```sh
[root@server4 ~]# docker run -d --name mysql --env='MYSQL_ALLOW_EMPTY_PASSWORD=1' mysql
[root@server4 ~]# docker run -d -p 80:80 -p 443:443 --name web --link mysql:db nginx
```

连接容器并不需要指明或映射被连接容器mysql的端口,被连接容器端口只在容器间的通信中使用,不会被暴露在外网中,也不会被其他容器访问到.建立连接唯一需要确保的条件是连接和被连接的容器都要处于运行状态.

另外为了避免连接容器名与连接容器内某些配置重名,Docker支持容器间使用别名进行连接.例如上面就使用db来作为容器mysql的别名.在web容器中可以使用db作为访问时的主机名.可以查看容器web中的/etc/hosts文件:

```sh
[root@server4 ~]# docker exec -it web cat /etc/hosts
127.0.0.1       localhost
172.17.0.4      db f2159e1085ed mysql
172.17.0.5      1286ab689c48
```

另外在web容器中,通过env命令能看到mysql容器的环境变量.

```sh
[root@server4 ~]# docker exec -it web env
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=1286ab689c48
TERM=xterm
DB_PORT=tcp://172.17.0.4:3306
DB_PORT_3306_TCP=tcp://172.17.0.4:3306
DB_PORT_3306_TCP_ADDR=172.17.0.4
DB_PORT_3306_TCP_PORT=3306
DB_PORT_3306_TCP_PROTO=tcp
DB_PORT_33060_TCP=tcp://172.17.0.4:33060
DB_PORT_33060_TCP_ADDR=172.17.0.4
DB_PORT_33060_TCP_PORT=33060
DB_PORT_33060_TCP_PROTO=tcp
DB_NAME=/web/db
DB_ENV_MYSQL_ALLOW_EMPTY_PASSWORD=1
DB_ENV_GOSU_VERSION=1.12
DB_ENV_MYSQL_MAJOR=8.0
DB_ENV_MYSQL_VERSION=8.0.27-1debian10
NGINX_VERSION=1.21.3
NJS_VERSION=0.6.2
PKG_RELEASE=1~buster
HOME=/root
```



