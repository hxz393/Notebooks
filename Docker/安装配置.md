# 安装配置

## 前置条件

由于Docker运行于Linux内核中,因此对于系统要求如下:

- 系统必须位为64位操作系统;
- 系统内核版本需要大于3.10;
- 硬盘要足够大.

可以使用以下命令查询系统位数和内核版本:

```sh
[root@server3 ~]# uname -r
3.10.0-1160.42.2.el7.x86_64
```

Docker引擎分为两个版本,社区版本(CE, Community Edition)和企业版本(EE, Enterprise Edition).通常安装社区稳定版.



## 安装Docker

在之前安装过Docker的主机上,需要完全卸载后再安装.

全新安装需要先修改仓库配置,增加docker-ce安装源:

```sh
[root@server4 ~]# yum install -y yum-utils
[root@server4 ~]# yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
Loaded plugins: fastestmirror
adding repo from: https://download.docker.com/linux/centos/docker-ce.repo
grabbing file https://download.docker.com/linux/centos/docker-ce.repo to /etc/yum.repos.d/docker-ce.repo
repo saved to /etc/yum.repos.d/docker-ce.repo
```

假如要安装nightly或test版本,使用下面的命令来启用对应仓库.关闭使用--disable参数:

```sh
[root@server4 ~]# yum-config-manager --enable docker-ce-nightly
[root@server4 ~]# yum-config-manager --enable docker-ce-test
```

安装最新版docker-ce:

```sh
[root@server4 ~]# yum install - docker-ce docker-ce-cli containerd.io
```

要安装特定版本,可以使用yum list来查询:

```sh
[root@server4 ~]# yum list docker-ce --showduplicates | sort -r
docker-ce.x86_64            3:20.10.9-3.el7                    docker-ce-stable 
docker-ce.x86_64            3:20.10.9-3.el7                    @docker-ce-stable
docker-ce.x86_64            3:20.10.8-3.el7                    docker-ce-stable 
```

例如安装20.10.8版本:

```sh
[root@server4 ~]# yum install docker-ce-20.10.8 docker-ce-cli-20.10.8 containerd.io
```



## 更新Docker

在docker仓库源启用的情况下,使用yum upgrade来更新:

```sh
[root@server4 ~]# yum upgrade
```



## 卸载Docker

使用下面的命令完全卸载Docker旧版本及相关程序:

```sh
[root@server4 ~]# yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine
```

删除新版Docker引擎:

```sh
[user10@server4 ~]$ yum remove docker-ce docker-ce-cli containerd.io
```

删除Docker使用的库,镜像和容器等数据:

```sh
[root@server4 ~]# rm -rf /var/lib/docker
[root@server4 ~]# rm -rf /var/lib/containerd
```



## 启动参数

Docker服务启动实际上是调用了dockerd命令,dockerd常用启动参数如下:

| 参数                                | 说明                             |
| ----------------------------------- | -------------------------------- |
| --api-cors-header=""                | 设定远程访问API所需的cors-header |
| -b, --bridge=""                     | 将容器网络访问方式设置为桥接模式 |
| --bip=""                            | 设定网络桥IP                     |
| -D, --debug=false                   | 启动Debug模式                    |
| -d, --daemon=false                  | 启动守护进程模式                 |
| --default-gateway=""                | 所有容器默认使用IPv4地址         |
| --dns=[]                            | 使用指定的DNS服务器              |
| --default-ulimit=[]                 | 设定容器默认的ulimit参数         |
| -e, --exec-driver="native"          | 设定Docker使用的exec-driver      |
| -exec-opt=[]                        | 设定exec-driver参数              |
| --exec-root="/var/run/Docker"       | 设定exec-driver默认根目录地址    |
| --fixed-cidr=""                     | 设定IPv4子网段                   |
| -G, --group="Docker"                | 设定UNIX Socket文件用户所属组    |
| -g, --graph="/var/lib/Docker"       | 设定Docker runtime时的根目录地址 |
| -H, --host=[]                       | 设定UNIX Socket文件监听位置      |
| --icc=ture                          | 允许容器之间互相通信             |
| --insecure-registry=[]              | 设定可信任仓库地址               |
| --ip=0.0.0.0                        | 设定绑定容器端口信息时的默认IP   |
| --ip-forward=true                   | 允许转发IPv4数据包               |
| --ip-masq=true                      | 允许IP伪装                       |
| --iptables=true                     | 允许修改iptables数据             |
| --ipv6=true                         | 允许使用IPv6网络                 |
| -l, --log-level="info"              | 设定日志输出等级                 |
| --label=[]                          | 按照Key=Value设定Daemon标签      |
| --log-driver="json-file"            | 设定日志记录格式                 |
| --log-opt=[]                        | 设定日志记录驱动参数             |
| --mtu=0                             | 设定容器MTU值                    |
| -p, --pidfile="/var/run/Docker.pid" | 设定Docker.pid文件路径           |
| --registry-mirror=[]                | 设定优先访问的仓库镜像地址       |
| -s, --storage-driver=""             | 设定数据储存驱动方式             |
| --selinux-enabled=false             | 启动SELinux                      |
| --storage-opt=[]                    | 设定数据储存驱动参数             |
| --tls=false                         | 启动TLS安全认证                  |
| --tlscacert="~/.Docker/ca.pem"      | 设定CA证书位置                   |
| --tlscert="~/.Docker/cert.pem"      | 设定TLS证书位置                  |
| --tlskey="~/.Docker/key.pem"        | 设定TLS密钥位置                  |
| --tlsverify=false                   | 启动TLS来验证远程访问请求        |
| --userland-proxy=true               | 启动指定的网络代理               |
| -v, --version=false                 | 输出Docker版本信息               |

如果参数后有[]标记,代表此参数可以使用多次.例如开启Debug模式,并监听本地2376端口:

```sh
[root@server4 ~]# dockerd -D -H tcp:127.0.0.1:2376
```

可以将启动参数写入/etc/docker/daemon.json内,由dockerd服务启动时读取.

```sh
[root@server4 ~]# vi /etc/docker/daemon.json
{
        "debug": true,
        "hosts": ["tcp://127.0.0.1:2376"]
}
```

也可以修改文件/usr/lib/systemd/system/docker.service中ExecStart后面的参数来配置启动参数.



## 配置用户

Docker安装时会新建一个docker组,可以将普通用户加入此组,这样普通用户就能直接运行docker命令:

```sh
[root@server4 ~]# useradd -p user10 user10
[root@server4 ~]# su -l user10
[user10@server4 ~]$ docker image ls
Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get "http://%2Fvar%2Frun%2Fdocker.sock/v1.24/images/json": dial unix /var/run/docker.sock: connect: permission denied
[user10@server4 ~]$ su -c 'usermod -G docker user10'
[user10@server4 ~]$ docker image ls
REPOSITORY    TAG       IMAGE ID       CREATED       SIZE
hello-world   latest    feb5d9fea6a5   3 weeks ago   13.3kB
```





