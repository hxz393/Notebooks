# 磁盘分区

## MBR分区表

目前主流分区表格式有MBR和GPT.早期的Linux系统为了相容于Windows磁盘,使用的是支持Windows的MBR.

MBR分区表无法支持2T以上容量的硬盘.

### 第一个扇区

MBR分区表第一个扇区(512kBytes)用来记录两个重要的信息:

- **主引导分区**(MBR, Master Boot Record):

  用来安装引导加载程序的地方,有446Bytes大小.

- **分区表**(Partition Table):

  记录整块硬盘的分区状态,有64Bytes大小.

如果第一个扇区出现物理坏道,整块硬盘都不可用.

### 主引导分区

MBR只有446Bytes,主要提供下面功能:

- 提供菜单,可以选择不同开机选项,实现多重引导;
- 载入内核文件,指向可开机的程序区段开启动系统;
- 转交其他loader,将引导加载功能转交给其他loader负责.

### 分区表

分区表记录了每个分区的起始柱面号,分区只是针对那64bytes的分区表进行设置.

由于只有64 Bytes大小,所以仅能写入四组分区信息,这四组分区信息称为主(Primary)或扩展(Extended)分区.

分区的最小单位为柱面(Cylinder).

主和扩展分区在Linux系统中表示为sda[1-4].

### 扩展分区

扩展分区无法格式化,可以在扩展分区继续分出逻辑分区.

扩展分区的目的是使用额外的扇区来记录分区信息.做法是在每个逻辑分区的最前面几个扇区记录分区信息.

扩展分区最多只有一个(操作系统的限制).

考虑到磁盘的连续性,一般将扩展分区的柱面号分配在主分区之后.

### 逻辑分区

由扩展分区分出来的分区称为逻辑分区(Logical Partition).

逻辑分区在Linux系统中从hda5开始计算表示.

在一个扩展分区内相邻的逻辑分区可以合并,否则只能重建扩展分区.

如果扩展分区被破坏,所有的逻辑分区将被删除,因为逻辑分区的信息都记录在扩展分区里.



## GPT分区表

为了处理4K扇区的硬盘和固态硬盘,GPT分区表抛弃掉原先以柱面为单位的计算法,改用逻辑区块位址(LBA, Logical Block Address)来规划.默认大小为512Bytes,第一个LBA为LBA0.

GPT分区表使用前34个LBA区块来记录分区信息,此外磁盘最后33个LBA会留存一个分区表备份.

### MBR相容区块

LBA0用来兼容MBR格式,不同的是在原本分区表记录段仅放入一个特殊标志的分区,用来表示此磁盘为GPT磁盘.

### GPT表头记录

LBA1记录了分区表本身的位置和大小,备份分区表存放位置,分区表校验机制码(CRC32).系统若检测到分区表有错误,可以通过这个记录区来取得备份的分区表恢复.

### 分区表

分区表存放在LBA2-33位置.从LBA2开始,每个LBA都可以记录4笔分区记录,所以默认可以记录128个分区记录.

每笔记录占用128Bytes空间,具体内容如下表:

| 起始字节 | 长度   | 内容                                  |
| -------- | ------ | ------------------------------------- |
| 0        | 16字节 | 分区类型GUID                          |
| 16       | 16字节 | 分区GUID                              |
| 32       | 8字节  | 起始LBA(小端序)                       |
| 40       | 8字节  | 末尾LBA                               |
| 48       | 8字节  | 属性标签(如bit60表示"只读")           |
| 56       | 72字节 | 分区名,可以包括36个UTF-16(小端序)字符 |



## 开机流程

目前主机系统在载入硬件驱动方面的程序,有使用BIOS与UEFI两种.

### BIOS搭配MBR/GPT

开机流程流程如下:

1. 由BIOS扫描出电脑中的储存设备,接着按照用户设置的启动顺序,读取硬盘第一个扇区;
2. 读取到MBR后,由MBR内的引导加载程序(Boot Loader)工作,识别文件系统格式,加载核心文件;
3. 核心文件开始操作系统的功能.

GPT格式启动过程一样,差异在于开机管理程序是否支持GPT.

如果使用grub引导的话,得额外分个"BIOS boot"分区来放置其他开机过程所需得程序码.

### 多重引导

引导加载程序除了可以安装在MBR外,还可以安装在每个分区的引导扇区(Boot Sector).

例如硬盘第一和第二分区分别安装了Windows和Linux.开机装载第一个分区引导加载程序,此时会出现分支选项.可以选择启动Windows直接加载第一个分区中的Windows内核文件.选择启动Linux则转到第二个分区的引导扇区,由第二个分区的引导加载程序完成Linux系统启动工作.

如果要安装多重开机,一般先安装Windows再安装Linux,因为Windows安装时会直接覆盖掉MBR以及自己所在分区的启动扇区,而Linux安装时可以选择将引导加载程序安装在MBR或个别分区的启动扇区,之后修改loader加入Windows开机选项,完成双系统引导功能.

### UEFI BIOS搭配GPT

UEFI(Unified Extensible Firmware Interface)为新一代BIOS,可以使用一个特制的shell来做些管理工作.

