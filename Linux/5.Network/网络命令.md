# 网络命令

## 网络设置

虽然现在网络设置可以通过nmcli来完整,但旧的命令依然可用.

### ifconfig

ifconfig命令可以手动启动,查看与修改网络接口参数,语法如下:`ifconfig interface [选项]`

interface为网卡接口名称,例如eth0,ens34等.选项可用参数:

| 参数      | 说明                 |
| --------- | -------------------- |
| up, down  | 启动或关闭端口       |
| mtu       | 设置MTU数值,单位byte |
| netmask   | 设置子网掩码         |
| broadcast | 设置广播地址         |

例如查询ens33网卡的信息:

```sh
[root@server201 ~]# ifconfig ens33
ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.2.201  netmask 255.255.0.0  broadcast 192.168.255.255
        inet6 fe80::df56:57bc:63b:6ccd  prefixlen 64  scopeid 0x20<link>
        inet6 240e:383:406:ac00:3d71:87ed:5f5:fde  prefixlen 64  scopeid 0x0<global>
        inet6 fe80::6216:718c:bab2:a10d  prefixlen 64  scopeid 0x20<link>
        ether 00:0c:29:da:7d:5c  txqueuelen 1000  (Ethernet)
        RX packets 444049  bytes 506386469 (482.9 MiB)
        RX errors 0  dropped 64242  overruns 0  frame 0
        TX packets 42962  bytes 7774934 (7.4 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

其中RX表示数据包接收情况,TX则为数据包发送情况.注意其中collisions数值表示冲突次数.

可以设置网卡仿真接口,比如设置一个ens33:0为192.168.3.201:

```sh
[root@server201 ~]# ifconfig ens33:0 192.168.3.201
[root@server201 ~]# ifconfig ens33:0
ens33:0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.3.201  netmask 255.255.255.0  broadcast 192.168.3.255
        ether 00:0c:29:da:7d:5c  txqueuelen 1000  (Ethernet)
```

ifconfig设置的临时网络参数在重启网络服务后会重置消失.

### route

route命令用来修改本机的路由表,命令用法如下:

`route [-nee]`

`route add [-net|-host] [网络或主机] netmask [mask] [gw|dev]`

`route del [-net|-host] [网络或主机] netmask [mask] [gw|dev]`

参数说明:

| 参数    | 说明                                    |
| ------- | --------------------------------------- |
| -n      | 直接显示IP和端口,而不是通信协议或主机名 |
| -ee     | 显示更详细的信息                        |
| -net    | 表示后面接的路由指向一个网络            |
| -host   | 表示后面接的路由指向单个主机            |
| netmask | 可以设置netmask决定网络的大小           |
| gw      | gateway的缩写,后面接网关ip              |
| dev     | 指定工作网卡,后面接ens33等              |

查询下本机路由表:

```sh
[root@server201 ~]# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         gateway         0.0.0.0         UG    102    0        0 ens33
192.168.0.0     0.0.0.0         255.255.0.0     U     102    0        0 ens33
[root@server201 ~]# route -nee
Kernel IP routing table
Destination   Gateway       Genmask     Flags Metric Ref    Use Iface   MSS   Window irtt
0.0.0.0       192.168.2.1   0.0.0.0     UG    102    0        0 ens33   0     0      0
192.168.0.0   0.0.0.0       255.255.0.0 U     102    0        0 ens33   0     0      0
```

第一行表达去往任何地址(0.0.0.0)都要通过网口ens33转向网关192.168.2.1.

第二行表示去192.168.0.0/16网段地址不需要通过网关(0.0.0.0),直接通过网口ens33出去.

其中Flags标志有多种值:

- U(route is up): 代表该路由已启用.
- H(target is a host): 代表该行路由目标为主机.
- G(use gateway): 代表需要经过网关处理数据包传递.
- R(reinstate route for dynamic routing): 使用动态路由时,恢复路由信息的标志.
- D(dynamically installed by daemon or redirect): 代表动态路由.
- M(modified from routing daemon or redirect): 代表路由已经被修改.
- !(reject route): 代表这条路由会被阻止.

路由是依据路由表的顺序执行.例如上面的路由表,本来发往192.168.2.100的局域网数据,也会通过192.168.2.1处理,后面那条路由设置不起作用.

所以试下调整顺序,先删除默认路由,再把默认路由加回去:

```sh
[root@server201 ~]# route del -net 0.0.0.0 netmask 0.0.0.0 gw 192.168.2.1
[root@server201 ~]# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.0.0     0.0.0.0         255.255.0.0     U     102    0        0 ens33
[root@server201 ~]# route add -net 0.0.0.0 netmask 0.0.0.0 gw 192.168.2.1
[root@server201 ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.2.1     0.0.0.0         UG    0      0        0 ens33
192.168.0.0     0.0.0.0         255.255.0.0     U     102    0        0 ens33
```

结果并没有变化,因为Metric定义了优先级.

一般修改route用于指定不同端口指向网段.重启网络服务后会还原路由表.

### ip

ip命令综合了ifconfig与route命令的功能,命令语法:`ip [选项] [动作] [命令]`

例如查看网卡ens33信息:

```sh
[root@server201 ~]# ip -s link show ens33
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether 00:0c:29:da:7d:5c brd ff:ff:ff:ff:ff:ff
    RX: bytes  packets  errors  dropped overrun mcast   
    506917745  449906   0       66383   0       0       
    TX: bytes  packets  errors  dropped carrier collsns 
    7955626    44475    0       0       0       0  
```

不加-s参数显示结果简略一点.如果要修改网卡信息可以用set动作.例如修改ens33的MAC地址:

```sh
[root@server201 ~]# ip link set ens33 address 00:0c:29:da:7d:5c
```

修改网卡IP地址有关的参数使用address动作.例如给ens33增加一个虚拟接口配置IP:

```sh
[root@server201 ~]# ip address add 192.168.3.101/24 broadcast 192.168.3.255 dev ens33 label ens33:new3
[root@server201 ~]# ip address show ens33
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:da:7d:5c brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.201/16 brd 192.168.255.255 scope global noprefixroute ens33
       valid_lft forever preferred_lft forever
    inet 192.168.3.101/24 brd 192.168.3.255 scope global ens33:new3
       valid_lft forever preferred_lft forever
    inet6 240e:383:406:ac00:3d71:87ed:5f5:fde/64 scope global noprefixroute dynamic 
       valid_lft 3600sec preferred_lft 3600sec
    inet6 fe80::df56:57bc:63b:6ccd/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
[root@server201 ~]# ip address del 192.168.3.101/24 dev ens33
```

修改路由相关设定使用route动作,用法和route命令差不多.先使用route show查看下路由:

```sh
[root@server201 ~]# ip route show
default via 192.168.2.1 dev ens33 
192.168.0.0/16 dev ens33 proto kernel scope link src 192.168.2.201 metric 102 
```

结果比route命令多了两个字段:prote指路由的路由协议,scope指路由的范围.

下面添加一条路由到192.168.3.0/24网段,通过ens37端口进出:

```sh
[root@server201 ~]# ip route add 192.168.3.0/24 dev ens37
[root@server201 ~]# ip route show
default via 192.168.2.1 dev ens33 
192.168.0.0/16 dev ens33 proto kernel scope link src 192.168.2.201 metric 102 
192.168.3.0/24 dev ens37 scope link 
```

添加默认路由和删除路由:

```sh
[root@server201 ~]# ip route add default via 192.168.2.1 dev ens33
RTNETLINK answers: File exists
[root@server201 ~]# ip route del 192.168.3.0/24
```



## 网络诊断

用于在网络出现故障时跟踪可能的错误原因.

### ping

ping命令通过ICMP数据包来进行整个网络的状态报告.常用参数有:

| 参数          | 说明                                                         |
| ------------- | ------------------------------------------------------------ |
| -c 数值       | 可以定义ping的次数                                           |
| -n            | 不进行IP与主机名的解析,只用IP显示                            |
| -s 数值       | 发送出去的ICMP数据包大小,默认为56 bytes                      |
| -t 数值       | TTL的数值,默认是255                                          |
| -W 数值       | 等待相应超时秒数                                             |
| -M [do\|dont] | 主要用来检测网络MTU数值大小,do表示不拆分数据包,dont表示可以拆分. |

直接ping baidu.com看看:

```sh
[root@server201 ~]# ping baidu.com -c 3
PING baidu.com (220.181.38.251) 56(84) bytes of data.
64 bytes from baidu.com (220.181.38.251): icmp_seq=1 ttl=52 time=39.0 ms
64 bytes from baidu.com (220.181.38.251): icmp_seq=1 ttl=51 time=39.1 ms (DUP!)
64 bytes from baidu.com (220.181.38.251): icmp_seq=1 ttl=52 time=39.6 ms (DUP!)
64 bytes from baidu.com (220.181.38.251): icmp_seq=1 ttl=51 time=39.6 ms (DUP!)
From 192.168.2.102 (192.168.2.102) icmp_seq=2 Redirect Network(New nexthop: gateway (192.168.2.1))
From 192.168.2.102 (192.168.2.102): icmp_seq=2 Redirect Network(New nexthop: gateway (192.168.2.1))
64 bytes from baidu.com (220.181.38.251): icmp_seq=2 ttl=52 time=39.5 ms

--- baidu.com ping statistics ---
2 packets transmitted, 2 received, +3 duplicates, +1 errors, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 39.099/39.392/39.611/0.257 ms
```

结果可得下面这些信息:

- 64 bytes: 表示发送ICMP数据包大小,最大可以设置-s 65507.
- icmp_seq=1: ICMP的检测次数,第一次为1.
- ttl=52: TTL与IP数据包内的TTL相同,每经过一个带有MAC的节点时TTL减1,默认TTL为255.
- time=39.1ms: 响应时间,越短越好.

下面这样可以检测MTU:

```sh
[root@server201 ~]# ping -s 9000 -M do 192.168.2.101 
PING 192.168.2.101 (192.168.2.101) 9000(9028) bytes of data.
ping: local error: Message too long, mtu=1500
```

