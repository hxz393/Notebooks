# 服务管理

## 服务定义

可以将Daemon(守护进程)与Service(服务)视为同一个东西不同说法.

服务是常驻内存当中的进程,通常都是负责一些系统所提供的功能以服务用户各项任务.

一般daemon类型的程序都会加上d在文件名最后.



## Init脚本管理

SysV(System V)的init脚本程序处理方式为:将第一个启动的程序称为init,然后由init去启动其他系统所需服务.

init的管理机制特性如下:

- **服务管理方式**

  服务启动bash脚本全放在/etc/init.d/下面,用统一方式来处理:

  - 启动: /etc/init.d/daemon start

  - 关闭: /etc/init.d/daemon stop

  - 重新启动: /etc/init.d/daemon restart

  - 状态查询: /etc/init.d/daemon status

- **服务启动分类**

  依据服务是独立启动还是被总管程序管理分为两大类:

  - 独立启动模式(Stand Alone):服务独立启动,常驻于内存中,反应速度块.

  - 总管程序(Super Daemon):由特殊的xinetd或inetd程序来管理.当用户请求某些功能时,xinetd才会去唤醒对应服务.当请求完毕服务也跟随停止.好处是统一管理,但启动服务有延时.

- **服务依赖问题**

  服务之间如果启动互相依赖,init不能解决依赖问题.

- **执行等级分类**

  init可以根据设定的运行等级(run level)来启动不同服务.总有7个执行等级,各执行等级启动脚本通过/etc/rc.d/rc[0-6]/SXXdaemon链接到/etc/init.d/daemon.

  链接文件名(SXXdaemon)的作用为指定启动顺序.依靠SXX的设置,开机时可以按顺序启动服务,同时也解决了服务依赖问题.

- **设定执行等级**

  通过下面命令来设置:

  - 开机启动: chkconfig daemon on

  - 取消开机启动: chkconfig daemon off

  - 查询是否开机启动: chkconfig --list daemon

- **执行等级切换**

  例如从命令行(run level 3)切换到图形界面(run level 5),只用init 5命令即可切换.init会主动分析/etc/rc.d/rc[3|5].d/这两个目录内的脚本,自动启动服务.



## Systemd服务管理

自从CentOS 7之后,服务管理机制由init脚本管理改为systemd启动服务管理.

Systemd的特性如下:

- **平行处理模式**

  旧的init启动脚本是线性模式,只能单任务处理.systemd可以让所有服务同时启动,更好利用多核心构架.

- **单命令控制**

  只需要一个syetemctl命令来处理事务.此外由于systemd常驻内存,因此任何要求(On-Demand)都会立刻处理.

- **自动处理服务依赖**

  由于systemd可以设置服务依赖检查,因此启动服务时,能自动启用相依赖服务.

- **依服务功能分类**

  systemd把服务定义为服务单元(Unit),并把它们归类到不同的服务类型(Type)中.旧的init仅能分为stand alone与super daemon两种,systemd可以分为service,socket,target等多种不同类型,方便记忆和管理.

- **可设置群组**

  systemd可将许多的功能合为一个Target项目,也就是集合有相同目标的服务到一个群组,通过群组统一执行.

- **向下兼容init服务脚本**

  systemd可以兼容旧init启动脚本,并且通过systemd来管理.

Systemd与Init的区别主要有下面这些:

- 在run level对应上,只有1,3,5对应到systemd的某些target类型,没有全部对应;

- systemctl支持的语法有限,没有init纯脚本自由;

- 没通过systemctl来启动的服务,systemd管理不了;

- systemd启动过程中不接受stdin传参.也就是不能与用户互动.



## systemd配置目录

systemd将daemon执行脚本称为一个服务单位,而每种服务单位依据功能来区分时,就分类为不同的类型.基本的类型包括系统服务,数据监听与交换的插槽档服务(socket),储存系统状态的快早类型,提供不同类似执行等级分类的操作环境(target)等等.他们放置在不同目录:

/usr/lib/systemd/system: 每个服务最主要的启动脚本设置,有点类似于/etc/init.d下面的文件

/run/systemd/system: 系统执行过程中所产生的服务脚本,这些脚本优先级比/usr/lib/systemd/system高

/etc/systemd/system: 管理员依据主机系统的需求所创建的执行脚本,有点像/etc/rc.d/rc5.d/Sxx之类的功能,执行优先级比/run/systemd/system高.

也就是说系统开机会不会执行某些服务其实是看/etc/systemd/system下面的设置,所以该目录下面就是一大堆链接文件.而实际执行的systemd启动脚本配置文件,其实都是放在/usr/lib/systemd/system/下面.因此要修改某个服务启动的设置要到/usr/lib/systemd/system下面找.



## systemd的Unit类型分类

/usr/lib/systemd/system/下面的数据以扩张名来区分不同的类型(type).

```sh
[root@101c7 home]# ll /usr/lib/systemd/system/ | grep -E '(vsftpd|multi|cron)'
-rw-r--r--. 1 root root  318 Aug  8  2019 crond.service
-rw-r--r--. 1 root root  492 Feb  2  2021 multi-user.target
drwxr-xr-x. 2 root root  258 Sep  7 05:54 multi-user.target.wants
lrwxrwxrwx. 1 root root   17 Sep  7 05:53 runlevel2.target -> multi-user.target
lrwxrwxrwx. 1 root root   17 Sep  7 05:53 runlevel3.target -> multi-user.target
lrwxrwxrwx. 1 root root   17 Sep  7 05:53 runlevel4.target -> multi-user.target
-rw-r--r--. 1 root root  171 Jun  9 12:15 vsftpd.service
-rw-r--r--. 1 root root  184 Jun  9 12:15 vsftpd@.service
-rw-r--r--. 1 root root   89 Jun  9 12:15 vsftpd.target
```

其中vsftpd和crond是服务(service),而multi-user算是执行环境相关的类型(target type)

常见的类型有下面这些:

.service一般服务类型:主要是系统服务,包括服务器本身所需要的本机服务以及网络服务.

.socket 内部程序数据交换的插槽服务(socket unit):主要是IPC(Inter-process communication)的传输信息插槽档(socket file)功能.这种类型的服务通常在监控讯息传递的插槽档,当有通过此socket传递星系说要链接服务时,就依据当时的状态将该用户的要求传送到对应的daemon,若daemon尚未启动,则启动该daemon后再传送用户的要求.使用socket类型的服务一般是比较不会被用到的服务,因此再开机时通常会稍微延迟启动时间.一般用于本机服务较多,例如图形界面很多软件都是通过socket来通信.

.target 执行环境类型(target unit): 其实是一群unit的集合.

.mount/.automount 文件系统挂载相关的服务:例如来自网络的自动挂载,NFS文件系统挂载等与文件系统相关性较高的程序管理

.path 侦测特定文件类型或目录类型(path unit): 某些服务需要侦测某些特定的目录来提供队列服务,例如最常见的打印服务,就是通过侦测打印队列目录来启动打印功能.这时就要.path服务类型支持了.

.timer 循环执行的服务(timer unit):有点类似anacrontab,不过是由systemd主动提供的,比anacrontab更有弹性.



## 通过systemctl管理服务

systemctl能执行的主要命令有:

| 命令      | 说明                                         |
| --------- | -------------------------------------------- |
| start     | 立即启动服务                                 |
| stop      | 立即关闭服务                                 |
| restart   | 立即重启服务                                 |
| reload    | 不关闭服务情况下,重新载入配置文件,让配置生效 |
| enable    | 设置开机启动                                 |
| disable   | 取消开机启动                                 |
| status    | 查看服务运行状态                             |
| is-active | 服务有没有处于活动状态                       |
| is-enable | 服务有没有开机启动                           |

### 通过systemctl管理单一服务

查看atd服务的状态:

```sh
[root@101c7 home]# systemctl status atd.service
â— atd.service - Job spooling tools
   Loaded: loaded (/usr/lib/systemd/system/atd.service; enabled; vendor preset: enabled)
   Active: active (running) since Tue 2021-09-14 00:01:48 EDT; 4 days ago
 Main PID: 27679 (atd)
   CGroup: /system.slice/atd.service
           â””â”€27679 /usr/sbin/atd -f

Sep 14 00:01:48 101c7 systemd[1]: Started Job spooling tools.
Sep 14 00:22:03 101c7 atd[28659]: Starting job 1 (a00001019eef86) for user 'root' (0)
Sep 14 00:24:00 101c7 atd[28768]: Starting job 2 (a00002019eef88) for user 'root' (0)
Sep 14 00:26:00 101c7 atd[28877]: Starting job 4 (a00004019eef8a) for user 'root' (0)
Sep 14 00:29:00 101c7 atd[29033]: Starting job 3 (a00003019eef8d) for user 'root' (0)
Sep 14 00:31:32 101c7 atd[29169]: Starting job 5 (a00005019eef8f) for user 'root' (0)
Sep 14 00:32:09 101c7 atd[29205]: Starting job 6 (a00006019eef8f) for user 'root' (0)
Sep 14 00:58:17 101c7 atd[30479]: Starting job 9 (b00009019eefaa) for user 'root' (0)
```

第一行说明了服务名和服务简介

第二行Loaded:第一个enable说明开机时会不会启动,enable为启动,disabled为不启动,后面vendor preset为默认值

第三行Active:现在这个unit的状态,正在运行(running)或是没有运行(dead) 已经运行的时长

第四行PID

下面:这个服务的日志文件信息,格式为:时间 讯息发送主机 哪一个服务的讯息 实际讯息的内容 

正常关闭atd服务

```sh
[root@101c7 home]# systemctl stop atd.service
[root@101c7 home]# systemctl status atd.service
â— atd.service - Job spooling tools
   Loaded: loaded (/usr/lib/systemd/system/atd.service; enabled; vendor preset: enabled)
   Active: inactive (dead) since Sat 2021-09-18 13:06:56 EDT; 1s ago
  Process: 27679 ExecStart=/usr/sbin/atd -f $OPTS (code=exited, status=0/SUCCESS)
 Main PID: 27679 (code=exited, status=0/SUCCESS)

Sep 18 13:06:56 101c7 systemd[1]: Stopping Job spooling tools...
Sep 18 13:06:56 101c7 systemd[1]: Stopped Job spooling tools.
```

最后两行日志显示状态改变

常见运行状态:

active(running):此时有一或多个进程正在运行

active(exited):







