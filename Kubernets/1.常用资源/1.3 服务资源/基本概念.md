# 基本概念

## 定义和作用

在K8s中不再能用记录pod IP方式让pod间互相通信,因为pod是活动的,会随着调度分配更换IP地址.K8s提供一种叫服务的资源,来解决pod间通信问题.每个Service其实就是微服务构架中的一个微服务.

服务的主要工作通过标签选择器选定一组pod对象,并为这组pod提供单一不变的接入点(固定IP),客户端通过访问此地址来访问后面任一pod对象.

若集群存在DNS附件,它会在Service创建时为其自动配置一个DNS名称以便客户端进行服务发现.本质上来说Server是一个四层代理服务器.

运行在每个Node上的Proxy进程其实就是一个智能的软件负载均衡器,在内部实现服务的负载均衡与会话保持机制.



## 从外部访问服务

有几种方式可以从外部访问服务:

- 将服务类型设置成NodePort

  每个集群节点都会在节点上打开一个端口,并将在该端口的流量转发重定向到基础服务.该服务仅在内部集群IP和端口上才可访问,但也可通过所有节点上的专用端口访问.

- 将服务的类型设置成LoadBalance

  NodePort类型的一种扩展,使得服务器可以通过一个专用的负载均衡器来访问,负载均衡器由云基础设施提供.负载均衡器将流量重定向到跨所有节点的节点端口,客户通过负载均衡器的IP连接到服务.

- 创建一个Ingress资源

  通过一个IP地址公开多个服务,他运行在HTTP层(第7层)因此可以提供更多功能.



## 外部连接的特性

当客户通过节点端口连接到服务时,随机选择的pod并不一定在接收连接的同一节点上运行,例如接收服务pod运行在node1,而服务在node2,必然会造成不必要的跳转.可以通过将服务配置为仅将外部通信重定向到接收连接节点上运行的pod.

具体操作是修改服务spec.externalTrafficPolicy为Local.假如节点上没有本地pod存在则连接将挂起,因此需要确保负载平衡器将连接转发给至少具有一个pod的节点.

有一个问题是,原先均匀分配给pod的流量,变为按节点平均分配.假如一个节点一个pod,另一个节点两个pod,原先每个pod接收流量为1/3,设置流量不转发后,变成一个pod承担1/2流量,另外两个分别承担1/4流量.

在没配置流量不转发,当通过节点端口接收到连接时,会对数据包执行源网络地址转换(SNAT),因此数据包的源IP将发生更改,后端pod无法看到实际的客户端IP.这种时候上面的配置能保留客户端IP,因为接受连接的节点和目标pod节点之间没有额外跳跃.



## 排除连接故障

首先确保从集群内连接到服务的集群IP,而不是从外部.

不要通过ping来判断服务是否可访问,服务的集群IP是虚拟IP.

如果已经定义了就绪探针,确保返回成功,否则该pod不会成为服务一部分.

要确认某个容器是服务的一部分,使用get endpoints来检查相应的端点对象.

如果通过FQDN来访问服务没用,查看是否可以使用集群IP访问.

尝试直接连接到pod IP以确认pod正在接收正确端口上的连接.

如果甚至无法通过pod的IP访问应用,确保应用不是仅绑定到本地主机.