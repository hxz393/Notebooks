# 控制器管理器

控制器主要工作是通过标签管理pod,确保系统真实状态朝API服务器定义的期望状态收敛.

它们是k8s上的一类对象,包括ReplicationController, ReplicaSet, Deployment, StatefulSet, Job等.控制器的定义通常由期望的副本数量,pod模板和标签选择器组成.

## 控制器工作

控制器通过API服务器监听资源(部署,服务等)变更,并执行相应操作.将实际状态调整为期望状态(资源spec部分定义)后,把新的实际状态写入资源的status部分.

控制器利用监听机制来订阅变更,但仍然会定期执行重列举操作来确保不会漏掉请求.

生命周期功能包括NS创建,Event垃圾回收,pod终止相关垃圾回收,级联垃圾回收及Node垃圾回收等.

通过源码分析,控制器工作原理如下:

- 每个控制器一般有一个构造器,内部会创建一个Informer,也就是监听器,每次API对象有更新就会被调用.
- 通常Informer会监听特定类型的资源变更事件.
- 控制器需要工作的时候都会调用worker()方法,实际函数通常保存在一个叫syncHandler或类似字段里.该字段也在构造器里初始化,可以在那找到被调用函数名.



## 控制器类型

### Replication控制器

启动RC资源的控制器叫Replication管理器.RC管理器通过监听机制订阅可能影响期望的复制集数量或符合条件pod数量的变更事件.

任何变化将触发RC控制器重新检查期望与实际复制集数量,然后做出相应操作.它不会直接操作pod,而是创建新的pod清单到API服务器,API服务器让调度器和Kubelet执行pod管理操作.其他控制器也是这个流程.

### RS, DS和Job控制器

基本上和RC管理器一样.

### Deployment控制器

负责Deployment的实际状态与对应Deployment API对象的期望状态同步.每次Deploy对象修改后,控制器都会滚动升级到新的版本,通过创建一个RS来伸缩pod直到升级完成.

### StatefulSet控制器

类似RS控制器,根据定义创建管理pod,但同时还会初始化并管理每个pod实例的持久卷声明字段.

### Node控制器

管理Node资源,描述集群工作节点,保证节点对象列表的正确性.同时监控每个节点的健康状态,删除不可达节点的pod.

### Service控制器

用来提供稳定的pod访问服务.

### Endpoint控制器

维护端点列表.控制器同时监听Service和pod,当Service或pod被添加修改时,控制器会选中匹配Service中pod选择器的pod,将其IP和端口添加到Endpoint资源中.

Endpoint对象是个独立的对象,所以当需要时控制器会创建它,删除Service时被一同删除.

### Namespce控制器

删除一个Namespace资源时,命名空间内的所有资源都会被删除.控制器就是负责清除所有归属该命名空间的资源.

### PV控制器

当用户创建持久卷声明,控制器负责找到合适的持久卷与声明绑定.

查找方式是保存一份有序的持久卷列表,对于每种访问模式按照容量升序排列,返回列表的第一个卷.

当用于删除持久卷声明时会解绑卷,然后根据卷的回收策略进行处理.